#!/usr/bin/env sh
set -e

echo ""
echo "Running formatter..."
pnpm run format

git add .

FILES=$(git diff --cached --name-only | grep -E "(page|layout)\.tsx$" || true)

if [ -n "$FILES" ]; then
  BAD=""
  for f in $FILES; do
    if grep -q '"use client"' "$f"; then
      BAD="$BAD $f"
    fi
  done

  if [ -n "$BAD" ]; then
    echo ""
    echo "Forbidden: \"use client\" found in:"
    echo "$BAD"
    exit 1
  fi
fi

echo ""
echo "Running security audit (high+)..."
pnpm audit --audit-level high

if git diff --cached --numstat | awk '{ if ($1 > 50000) { print $2 } }' | grep -q .; then
  echo "Error: You are trying to commit a large file."
  exit 1
fi

echo ""
echo "Running build..."
pnpm build
